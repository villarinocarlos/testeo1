{% extends "base.html" %}
{% load static %}
{% block title %}Crear Usuario - InterHub{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <h1 class="h3 mb-4 text-dark text-center">Crear Usuario</h1>

      <!-- Mensaje global para errores (correo duplicado o requisitos) -->
      <div class="mt-2 text-center">
        {% if messages %}
          {% for msg in messages %}
            {% if msg|lower == "el usuario ya está en uso." %}
              <small class="text-danger">El usuario ya está en uso.</small>
            {% elif msg|lower == "no cumples con los requisitos para presentar estadía." %}
              <small class="text-danger">
                No cumples con los requisitos para presentar estadía.
              </small>
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>

      <form method="POST" class="user" onsubmit="return validarFormulario()">
        {% csrf_token %}
        <!-- Correo -->
        <div class="form-group position-relative">
          <label for="correo">Correo Electrónico</label>
          <input type="email" class="form-control" id="correo" name="correo"
                 placeholder="ejemplo@correo.com" required>
          <small id="correoError" class="text-danger" style="display:none; position:absolute; bottom:-1.2rem;"></small>
        </div>

        <!-- Contraseña -->
        <div class="form-group position-relative">
          <label for="contraseña">Contraseña</label>
          <input type="password" class="form-control" id="contraseña" name="contraseña"
                 placeholder="Contraseña" required>
          <small id="contraseñaError" class="text-danger" style="display:none; position:absolute; bottom:-1.2rem;"></small>
        </div>

        <!-- Rol -->
        <div class="form-group">
          <label for="rol">Rol de Usuario</label>
          <select class="form-control" id="rol" name="rol" required onchange="toggleCamposAlumno()">
            <option value="">Selecciona un rol</option>
            <option value="Admin">Admin</option>
            <option value="Empresario">Empresario</option>
            <option value="Alumno">Alumno</option>
          </select>
        </div>

        <!-- Campos Alumno -->
        <div id="camposAlumno" style="display: none;">
          <div class="form-group position-relative">
            <label for="creditos">Créditos (0 - 300)</label>
            <input type="number" class="form-control" id="creditos" name="creditos" placeholder="Ej: 180">
            <small id="creditosError" class="text-danger" style="display:none; position:absolute; bottom:-1.2rem;"></small>
          </div>
          <div class="form-group position-relative">
            <label for="semestre">Semestre (1 - 10)</label>
            <input type="number" class="form-control" id="semestre" name="semestre" placeholder="Ej: 7">
            <small id="semestreError" class="text-danger" style="display:none; position:absolute; bottom:-1.2rem;"></small>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block mt-4">Crear Usuario</button>
      </form>
    </div>
  </div>
</div>

<script>
  function toggleCamposAlumno() {
    const rol = document.getElementById('rol').value;
    const camposAlumno = document.getElementById('camposAlumno');
    if (rol === 'Alumno') {
      camposAlumno.style.display = 'block';
    } else {
      camposAlumno.style.display = 'none';
      document.getElementById('creditos').value = '';
      document.getElementById('semestre').value = '';
    }
  }

  // Función para mostrar error debajo del campo
  function mostrarError(campoErrorId, mensaje) {
    const errorElem = document.getElementById(campoErrorId);
    errorElem.innerText = mensaje;
    errorElem.style.display = 'block';
    setTimeout(() => {
      errorElem.style.display = 'none';
    }, 3000);
  }

  function validarFormulario() {
    let valido = true;
    // Ocultar errores previos
    document.getElementById('correoError').style.display = 'none';
    document.getElementById('contraseñaError').style.display = 'none';
    document.getElementById('creditosError').style.display = 'none';
    document.getElementById('semestreError').style.display = 'none';

    const correo = document.getElementById('correo').value.trim();
    const contraseña = document.getElementById('contraseña').value.trim();
    const rol = document.getElementById('rol').value;
    const creditos = document.getElementById('creditos').value.trim();
    const semestre = document.getElementById('semestre').value.trim();

    // Validar correo
    const regexCorreo = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!regexCorreo.test(correo)) {
      mostrarError('correoError', 'Por favor, ingresa un correo electrónico válido (ej: usuario@dominio.com).');
      valido = false;
    }

    // Validar contraseña sin espacios (6-20 caracteres, al menos 1 mayúscula y 1 dígito, sin espacios)
    const regexPass = /^(?!.*\s)(?=.*[A-Z])(?=.*\d)[A-Za-z\d_-]{6,20}$/;
    if (!regexPass.test(contraseña)) {
      mostrarError('contraseñaError', 'La contraseña debe tener 6-20 caracteres, al menos 1 mayúscula y 1 dígito, y no debe contener espacios ni caracteres especiales (solo - o _).');
      valido = false;
    }

    // Si rol es Alumno, validar que cumpla con los requisitos
    if (rol === 'Alumno') {
      if (!creditos || !semestre) {
        mostrarError('creditosError', 'Créditos y semestre son obligatorios para un Alumno.');
        mostrarError('semestreError', 'Créditos y semestre son obligatorios para un Alumno.');
        valido = false;
      } else {
        const c = parseInt(creditos);
        const s = parseInt(semestre);
        if (c < 180) {
          mostrarError('creditosError', 'El alumno debe tener al menos 180 créditos.');
          valido = false;
        }
        if (s < 7) {
          mostrarError('semestreError', 'El alumno debe estar en 7° semestre o superior.');
          valido = false;
        }
      }
    }

    return valido;
  }
</script>
{% endblock %}
